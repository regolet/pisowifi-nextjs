<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Settings - PISOWifi Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preview-wrapper {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 24px;
            text-align: center;
            width: 100%;
        }
        
        .preview-logo {
            font-size: 2rem;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .preview-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .preview-subtitle {
            color: #718096;
            font-size: 0.875rem;
            margin-bottom: 16px;
        }
        
        .preview-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            background: #fff5f5;
            color: #e53e3e;
            border: 1px solid #feb2b2;
            margin-bottom: 12px;
        }
        
        .preview-device-info {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 0.75rem;
            color: #4a5568;
            text-align: left;
        }
        
        .preview-device-info div {
            margin-bottom: 4px;
        }
        
        .preview-btn-primary {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-bottom: 8px;
        }
        
        .preview-btn-secondary {
            background: none;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .preview-footer {
            margin-top: 16px;
            font-size: 0.7rem;
            color: #a0aec0;
        }

        /* Mobile responsive */
        @media (max-width: 1023px) {
            .p-6 {
                padding: 1rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen lg:flex">

    <!-- Include Admin Sidebar -->
    <%- include('../partials/admin-sidebar', {currentPage}) %>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto pt-14 lg:pt-0 lg:ml-0">
            <div class="p-6">
                <div class="mb-6">
                    <h1 class="text-xl font-bold text-black">Portal Settings</h1>
                    <p class="text-sm text-gray-600 mt-1">Configure portal behavior, timers, and display settings</p>
                </div>

                <!-- Success/Error Messages -->
                <% if (typeof query !=='undefined' && query.updated==='true' ) { %>
                    <div id="successNotification" class="fixed top-6 right-6 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg flex items-center gap-3 shadow-lg z-50 transition-opacity duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                        Portal settings updated successfully!
                    </div>
                <% } %>

                <% if (typeof query !=='undefined' && query.error==='true' ) { %>
                    <div id="errorNotification" class="fixed top-6 right-6 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg flex items-center gap-3 shadow-lg z-50 transition-opacity duration-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
                        Failed to update settings. Please try again.
                    </div>
                <% } %>

                <form id="settingsForm" method="POST" action="/admin/portal-settings" enctype="multipart/form-data">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Settings Panel -->
                        <div class="lg:col-span-2 space-y-6">

                            <!-- Timer Configuration -->
                            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                                <div class="px-4 py-3 border-b border-gray-300">
                                    <h2 class="text-sm font-semibold text-black">Timer Configuration</h2>
                                </div>
                                <div class="p-4">
                                    <div class="max-w-md">
                                        <label class="block text-black text-sm font-medium mb-2" for="coin_timeout">
                                            Coin Insertion Timeout
                                        </label>
                                        <div class="flex items-center space-x-3">
                                            <input type="range" id="coin_timeout" name="coin_timeout"
                                                value="<%= settings.coin_timeout || 60 %>" min="30"
                                                max="300" step="10"
                                                class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                                                onchange="updatePreview()"
                                                oninput="updateTimeoutDisplay(this.value)">
                                            <span id="timeoutValue" class="text-lg font-semibold text-blue-600 min-w-[80px]">
                                                <%= settings.coin_timeout || 60 %>s
                                            </span>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>30s</span>
                                            <span class="text-gray-600">How long to wait for coin insertion</span>
                                            <span>5min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Menu -->
                            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                                <div class="px-4 py-3 border-b border-gray-300">
                                    <h2 class="text-sm font-semibold text-black">Note</h2>
                                </div>
                                <div class="p-4">
                                    <p class="text-sm text-gray-600">Session Management and Coin Abuse Protection settings have been moved to the <strong>Settings</strong> menu in the sidebar for centralized configuration.</p>
                                </div>
                            </div>

                            <!-- Portal Display Settings -->
                            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                                <div class="px-4 py-3 border-b border-gray-300">
                                    <h2 class="text-sm font-semibold text-black">Portal Display</h2>
                                </div>
                                <div class="p-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-black text-sm font-medium mb-2" for="portal_title">
                                                Portal Title
                                            </label>
                                            <input type="text" id="portal_title" name="portal_title"
                                                value="<%= settings.portal_title || 'PISOWifi Portal' %>"
                                                maxlength="50"
                                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="Enter portal title..."
                                                onchange="updatePreview()">
                                        </div>

                                        <div>
                                            <label class="block text-black text-sm font-medium mb-2" for="portal_subtitle">
                                                Portal Subtitle
                                            </label>
                                            <input type="text" id="portal_subtitle" name="portal_subtitle"
                                                value="<%= settings.portal_subtitle || 'Insert coins for internet access' %>"
                                                maxlength="100"
                                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="Enter portal subtitle..."
                                                onchange="updatePreview()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Media & Sounds -->
                            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                                <div class="px-4 py-3 border-b border-gray-300 flex items-center justify-between">
                                    <div>
                                        <h2 class="text-sm font-semibold text-black">Media & Sounds</h2>
                                        <p class="text-xs text-gray-600">Max 5MB per file. Accepted: images (png/jpg/webp/gif) and audio (mp3/wav/ogg).</p>
                                    </div>
                                    <div class="text-[10px] text-gray-500">Stored under /uploads</div>
                                </div>
                                <div class="p-4 space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label class="block text-black text-sm font-medium" for="banner_image">Banner Image</label>
                                            <input type="file" name="banner_image" id="banner_image" accept="image/*" class="w-full text-sm text-gray-700" />
                                            <input type="hidden" name="banner_image_url" value="<%= settings.banner_image_url || '' %>">
                                            <div class="space-y-1">
                                                <% if (settings.banner_image_url) { %>
                                                    <div class="text-xs text-gray-600">Current: <a class="underline text-blue-600" href="<%= settings.banner_image_url %>" target="_blank" rel="noopener">View banner</a></div>
                                                <% } else { %>
                                                    <div class="text-xs text-gray-500">No banner uploaded</div>
                                                <% } %>
                                                <img id="bannerPreview" data-current="<%= settings.banner_image_url || '' %>" src="<%= settings.banner_image_url || '' %>" alt="Banner preview" class="mt-2 rounded border border-gray-200 w-full h-32 object-cover" style="display: <%= settings.banner_image_url ? 'block' : 'none' %>;" />
                                                <div class="text-[11px] text-gray-500">Preview updates after selecting a new image.</div>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-black text-sm font-medium" for="coin_insert_audio">Coin Insert Sound</label>
                                            <input type="file" name="coin_insert_audio" id="coin_insert_audio" accept="audio/*" class="w-full text-sm text-gray-700" />
                                            <input type="hidden" name="coin_insert_audio_url" value="<%= settings.coin_insert_audio_url || '' %>">
                                            <% if (settings.coin_insert_audio_url) { %>
                                                <div class="text-xs text-gray-600">Current: <a class="underline text-blue-600" href="<%= settings.coin_insert_audio_url %>" target="_blank" rel="noopener">Listen</a></div>
                                            <% } else { %>
                                                <div class="text-xs text-gray-500">No sound uploaded</div>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label class="block text-black text-sm font-medium" for="coin_success_audio">Coin Success Sound</label>
                                            <input type="file" name="coin_success_audio" id="coin_success_audio" accept="audio/*" class="w-full text-sm text-gray-700" />
                                            <input type="hidden" name="coin_success_audio_url" value="<%= settings.coin_success_audio_url || '' %>">
                                            <% if (settings.coin_success_audio_url) { %>
                                                <div class="text-xs text-gray-600">Current: <a class="underline text-blue-600" href="<%= settings.coin_success_audio_url %>" target="_blank" rel="noopener">Listen</a></div>
                                            <% } else { %>
                                                <div class="text-xs text-gray-500">No sound uploaded</div>
                                            <% } %>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-black text-sm font-medium" for="coin_background_audio">Background Music</label>
                                            <input type="file" name="coin_background_audio" id="coin_background_audio" accept="audio/*" class="w-full text-sm text-gray-700" />
                                            <input type="hidden" name="coin_background_audio_url" value="<%= settings.coin_background_audio_url || '' %>">
                                            <% if (settings.coin_background_audio_url) { %>
                                                <div class="text-xs text-gray-600">Current: <a class="underline text-blue-600" href="<%= settings.coin_background_audio_url %>" target="_blank" rel="noopener">Listen</a></div>
                                            <% } else { %>
                                                <div class="text-xs text-gray-500">No background audio uploaded</div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GPIO Settings Info -->
                            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                                <div class="px-4 py-3 border-b border-gray-300">
                                    <h2 class="text-sm font-semibold text-black">GPIO & Hardware</h2>
                                </div>
                                <div class="p-4">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <div class="flex items-start gap-3">
                                            <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"></path></svg>
                                            <div>
                                                <h4 class="font-medium text-yellow-800">GPIO Integration</h4>
                                                <p class="text-sm text-yellow-700 mt-1">
                                                    GPIO coin detector integration is configured in the
                                                    <a href="/admin/gpio" class="underline font-medium hover:text-yellow-800">GPIO Settings</a> page.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-4">
                                <button type="submit"
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>
                                    Save Settings
                                </button>
                                <button type="button" onclick="resetToDefaults()"
                                    class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg transition-colors">
                                    Reset to Defaults
                                </button>
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div class="lg:col-span-1">
                            <div class="bg-gray-50 border border-gray-300 rounded-lg sticky top-20 lg:top-6">
                                <div class="px-4 py-3 border-b border-gray-300">
                                    <h2 class="text-sm font-semibold text-black">Portal Preview</h2>
                                </div>
                                <div class="p-4">
                                    <div class="preview-wrapper">
                                        <div class="preview-container">
                                            <!-- Portal Header -->
                                            <div class="preview-logo">
                                                <svg class="w-10 h-10 mx-auto text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                                                </svg>
                                            </div>
                                            <h3 id="preview-title" class="preview-title">
                                                <%= settings.portal_title || 'PISOWifi Portal' %>
                                            </h3>
                                            <p id="preview-subtitle" class="preview-subtitle">
                                                <%= settings.portal_subtitle || 'Insert coins for internet access' %>
                                            </p>
                                            
                                            <!-- Status -->
                                            <div class="preview-status">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                                                <span>Disconnected</span>
                                            </div>
                                            
                                            <!-- Device Info -->
                                            <div class="preview-device-info">
                                                <div><strong>MAC:</strong> AA:BB:CC:DD:EE:FF</div>
                                                <div><strong>IP:</strong> 10.0.0.50</div>
                                                <div class="flex items-center gap-1"><strong>Internet:</strong> <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg> Online</div>
                                            </div>
                                            
                                            <!-- Buttons -->
                                            <button class="preview-btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 6px;">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>
                                                Insert Coin
                                            </button>
                                            <button class="preview-btn-secondary" style="display: inline-flex; align-items: center; justify-content: center; gap: 6px;">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                                View Rates
                                            </button>
                                            
                                            <!-- Timeout indicator -->
                                            <div style="margin-top: 12px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 0.7rem; color: #0369a1; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                                Coin timeout: <strong id="preview-timeout"><%= settings.coin_timeout || 60 %></strong>s
                                            </div>
                                            
                                            <div class="preview-footer" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                                                Secure WiFi Connection
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <h4 class="font-medium text-blue-800 text-sm mb-2 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
                                            Tips
                                        </h4>
                                        <ul class="text-xs text-blue-700 space-y-1">
                                            <li>• Keep timeout between 30-120 seconds</li>
                                            <li>• Use short, clear titles</li>
                                            <li>• Test settings before deploying</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>

        <script>
            function updateTimeoutDisplay(value) {
                document.getElementById('timeoutValue').textContent = value + 's';
                document.getElementById('preview-timeout').textContent = value;
            }

            function updatePreview() {
                const title = document.getElementById('portal_title').value || 'PISOWifi Portal';
                const subtitle = document.getElementById('portal_subtitle').value || 'Insert coins for internet access';
                const timeout = parseInt(document.getElementById('coin_timeout').value) || 60;

                document.getElementById('preview-title').textContent = title;
                document.getElementById('preview-subtitle').textContent = subtitle;
                document.getElementById('preview-timeout').textContent = timeout;
            }

            function resetToDefaults() {
                if (confirm('Reset all settings to default values?')) {
                    document.getElementById('coin_timeout').value = 60;
                    document.getElementById('portal_title').value = 'PISOWifi Portal';
                    document.getElementById('portal_subtitle').value = 'Insert coins for internet access';
                    updateTimeoutDisplay(60);
                    updatePreview();
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                updatePreview();

                // Auto-hide notifications after 3 seconds
                const successNotif = document.getElementById('successNotification');
                const errorNotif = document.getElementById('errorNotification');
                if (successNotif) {
                    setTimeout(() => {
                        successNotif.style.opacity = '0';
                        setTimeout(() => successNotif.remove(), 300);
                    }, 3000);
                }
                if (errorNotif) {
                    setTimeout(() => {
                        errorNotif.style.opacity = '0';
                        setTimeout(() => errorNotif.remove(), 300);
                    }, 3000);
                }

                const bannerInput = document.getElementById('banner_image');
                const bannerPreview = document.getElementById('bannerPreview');
                if (bannerInput && bannerPreview) {
                    const existingSrc = bannerPreview.getAttribute('data-current');
                    if (existingSrc) {
                        bannerPreview.style.display = 'block';
                    }

                    bannerInput.addEventListener('change', function (event) {
                        const file = event.target.files && event.target.files[0];
                        if (file) {
                            const objectUrl = URL.createObjectURL(file);
                            bannerPreview.src = objectUrl;
                            bannerPreview.style.display = 'block';
                        } else if (existingSrc) {
                            bannerPreview.src = existingSrc;
                            bannerPreview.style.display = 'block';
                        } else {
                            bannerPreview.style.display = 'none';
                        }
                    });
                }
            });

            document.getElementById('settingsForm').addEventListener('submit', function () {
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...';
            });
        </script>

</body>

</html>
