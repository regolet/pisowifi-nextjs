<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Settings - PISOWifi Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom input styles */
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200;
        }
        
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        
        .settings-card {
            @apply bg-white rounded-lg shadow-md p-6 mb-6;
        }
        
        .settings-section {
            @apply border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0;
        }
        
        .preview-panel {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
        }
        
        .success-message {
            animation: slideInDown 0.3s ease-out;
        }
        
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-200 flex h-screen">
    
    <!-- Include Admin Sidebar -->
    <%- include('../partials/admin-sidebar', {currentPage}) %>
    
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-gray-300 px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-800">Portal Settings</h1>
                    <p class="text-gray-600 text-sm">Configure portal behavior, timers, and coin settings</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="resetToDefaults()" class="px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                        Reset to Defaults
                    </button>
                    <button type="submit" form="settingsForm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <% if (typeof query !== 'undefined' && query.updated === 'true') { %>
        <div class="mx-6 mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded success-message">
            ‚úÖ Portal settings updated successfully!
        </div>
        <% } %>
        
        <% if (typeof query !== 'undefined' && query.error === 'true') { %>
        <div class="mx-6 mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            ‚ùå Failed to update settings. Please try again.
        </div>
        <% } %>
        
        <!-- Content Area -->
        <div class="flex-1 overflow-auto p-6">
            <form id="settingsForm" method="POST" action="/admin/portal-settings">
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Settings Panel -->
                    <div class="lg:col-span-2">
                        
                        <!-- Timer & Coin Settings -->
                        <div class="settings-card">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">‚è±Ô∏è Timer & Coin Configuration</h3>
                            
                            <div class="settings-section">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="form-label" for="coin_timeout">
                                            Coin Insertion Timeout (seconds)
                                            <span class="text-xs text-gray-500 ml-1">- How long to wait for coins</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            id="coin_timeout" 
                                            name="coin_timeout" 
                                            value="<%= settings.coin_timeout || 60 %>"
                                            min="30" 
                                            max="300"
                                            class="form-input"
                                            onchange="updatePreview()"
                                        >
                                    </div>
                                    
                                    <div>
                                        <label class="form-label" for="coin_value">
                                            Coin Value (‚Ç±)
                                            <span class="text-xs text-gray-500 ml-1">- Value per coin inserted</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            id="coin_value" 
                                            name="coin_value" 
                                            value="<%= settings.coin_value || 5.00 %>"
                                            min="1" 
                                            max="50"
                                            step="0.25"
                                            class="form-input"
                                            onchange="updatePreview()"
                                        >
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div>
                                    <label class="form-label" for="time_per_peso">
                                        Time per Peso (minutes)
                                        <span class="text-xs text-gray-500 ml-1">- Internet time per peso spent</span>
                                    </label>
                                    <input 
                                        type="number" 
                                        id="time_per_peso" 
                                        name="time_per_peso" 
                                        value="<%= settings.time_per_peso || 6 %>"
                                        min="1" 
                                        max="60"
                                        class="form-input"
                                        onchange="updatePreview()"
                                    >
                                    <p class="text-xs text-gray-500 mt-1">
                                        Current: <span id="rate-display">‚Ç±5 = 30 minutes</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Portal Display Settings -->
                        <div class="settings-card">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üé® Portal Display</h3>
                            
                            <div class="settings-section">
                                <div>
                                    <label class="form-label" for="portal_title">
                                        Portal Title
                                    </label>
                                    <input 
                                        type="text" 
                                        id="portal_title" 
                                        name="portal_title" 
                                        value="<%= settings.portal_title || 'PISOWifi Portal' %>"
                                        maxlength="50"
                                        class="form-input"
                                        onchange="updatePreview()"
                                    >
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div>
                                    <label class="form-label" for="portal_subtitle">
                                        Portal Subtitle
                                    </label>
                                    <input 
                                        type="text" 
                                        id="portal_subtitle" 
                                        name="portal_subtitle" 
                                        value="<%= settings.portal_subtitle || 'Insert coins for internet access' %>"
                                        maxlength="100"
                                        class="form-input"
                                        onchange="updatePreview()"
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <!-- GPIO Settings -->
                        <div class="settings-card">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üîå GPIO & Hardware</h3>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                <div class="flex items-center">
                                    <div class="text-yellow-600 mr-2">‚ö†Ô∏è</div>
                                    <div>
                                        <h4 class="font-medium text-yellow-800">GPIO Integration</h4>
                                        <p class="text-sm text-yellow-700 mt-1">
                                            GPIO coin detector integration is configured in the 
                                            <a href="/admin/gpio" class="underline font-medium hover:text-yellow-800">GPIO Settings</a> page.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Preview Panel -->
                    <div class="lg:col-span-1">
                        <div class="settings-card sticky top-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üëÅÔ∏è Portal Preview</h3>
                            
                            <div class="preview-panel">
                                <div style="margin-bottom: 20px;">
                                    <h1 id="preview-title" style="font-size: 1.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                        <%= settings.portal_title || 'PISOWifi Portal' %>
                                    </h1>
                                    <p id="preview-subtitle" style="margin: 5px 0 0 0; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">
                                        <%= settings.portal_subtitle || 'Insert coins for internet access' %>
                                    </p>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin: 15px 0;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;">
                                        <div style="margin-bottom: 8px;">ü™ô <strong>Coin Value:</strong> <span id="preview-coin-value">‚Ç±5.00</span></div>
                                        <div style="margin-bottom: 8px;">‚è±Ô∏è <strong>Timeout:</strong> <span id="preview-timeout">60</span> seconds</div>
                                        <div>üí° <strong>Rate:</strong> <span id="preview-rate">‚Ç±5 = 30 min</span></div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(255,193,7,0.2); border: 1px dashed rgba(255,193,7,0.5); border-radius: 6px; padding: 10px; margin-top: 15px;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">
                                        This is how your portal will appear to users
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                <div class="text-blue-800 text-sm">
                                    <h4 class="font-medium mb-2">üí° Tips</h4>
                                    <ul class="text-xs space-y-1">
                                        <li>‚Ä¢ Keep timeout between 30-120 seconds</li>
                                        <li>‚Ä¢ Coin value should match your actual coins</li>
                                        <li>‚Ä¢ Test settings before deploying</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </form>
        </div>
        
    </div>

    <script>
        function updatePreview() {
            // Update title and subtitle
            const title = document.getElementById('portal_title').value || 'PISOWifi Portal';
            const subtitle = document.getElementById('portal_subtitle').value || 'Insert coins for internet access';
            const coinValue = parseFloat(document.getElementById('coin_value').value) || 5.00;
            const timeout = parseInt(document.getElementById('coin_timeout').value) || 60;
            const timePerPeso = parseInt(document.getElementById('time_per_peso').value) || 6;
            
            document.getElementById('preview-title').textContent = title;
            document.getElementById('preview-subtitle').textContent = subtitle;
            document.getElementById('preview-coin-value').textContent = '‚Ç±' + coinValue.toFixed(2);
            document.getElementById('preview-timeout').textContent = timeout;
            
            // Calculate and display rate
            const timeForCoin = coinValue * timePerPeso;
            const rateText = `‚Ç±${coinValue.toFixed(2)} = ${timeForCoin} min`;
            document.getElementById('preview-rate').textContent = rateText;
            document.getElementById('rate-display').textContent = rateText;
        }
        
        function resetToDefaults() {
            if (confirm('Reset all settings to default values? This will overwrite your current configuration.')) {
                document.getElementById('coin_timeout').value = 60;
                document.getElementById('coin_value').value = 5.00;
                document.getElementById('time_per_peso').value = 6;
                document.getElementById('portal_title').value = 'PISOWifi Portal';
                document.getElementById('portal_subtitle').value = 'Insert coins for internet access';
                updatePreview();
            }
        }
        
        // Initialize preview on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePreview();
        });
        
        // Form submission with loading state
        document.getElementById('settingsForm').addEventListener('submit', function() {
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Saving...';
        });
    </script>

</body>
</html>