<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History - PISOWifi Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Compact table styling */
        table th,
        table td {
            padding: 0.5rem 1rem !important;
        }
        table tbody tr {
            height: auto !important;
        }

        /* Mobile responsive */
        @media (max-width: 1023px) {
            .p-6 {
                padding: 1rem !important;
            }
            table th, table td {
                padding: 0.375rem 0.5rem !important;
                font-size: 0.75rem;
            }
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen lg:flex">
    <%- include('../partials/admin-sidebar', { currentPage: 'transactions' }) %>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto pt-14 lg:pt-0 lg:ml-0">
        <div class="p-6">
            <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold text-black">Sales History</h1>
                    <p class="text-sm text-gray-600 mt-1">View all coin transactions and payments</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportTransactions()"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Export CSV
                    </button>
                    <button onclick="refreshTransactions()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"></path></svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs text-gray-600">Today's Sales</p>
                            <p id="todaySales" class="text-lg font-semibold text-black">₱0.00</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 20c-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9-4.038 9-9 9zm3.5-9c0 1.933-1.567 3.5-3.5 3.5S8.5 13.933 8.5 12 10.067 8.5 12 8.5s3.5 1.567 3.5 3.5z"></path></svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs text-gray-600">Today's Coins</p>
                            <p id="todayCoins" class="text-lg font-semibold text-black">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs text-gray-600">Total Transactions</p>
                            <p id="totalTransactions" class="text-lg font-semibold text-black">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"></path></svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs text-gray-600">All-Time Revenue</p>
                            <p id="allTimeRevenue" class="text-lg font-semibold text-black">₱0.00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Options -->
            <div class="bg-gray-50 border border-gray-300 rounded-lg mb-6">
                <div class="px-4 py-3 border-b border-gray-300">
                    <h2 class="text-sm font-semibold text-black">Filter Transactions</h2>
                </div>
                <div class="p-4">
                    <form id="filter-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                            <input type="date" id="startDate" name="startDate"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                            <input type="date" id="endDate" name="endDate"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
                            <select id="statusFilter" name="status"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm">
                                <option value="">All</option>
                                <option value="COMPLETED">Completed</option>
                                <option value="PENDING">Pending</option>
                                <option value="FAILED">Failed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Payment Method</label>
                            <select id="methodFilter" name="method"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm">
                                <option value="">All</option>
                                <option value="COIN">Coin</option>
                                <option value="FREE">Free Access</option>
                            </select>
                        </div>
                        <div class="flex items-end gap-2">
                            <button type="submit"
                                class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors text-sm">
                                Apply Filter
                            </button>
                            <button type="button" onclick="clearFilters()"
                                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors text-sm">
                                Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="bg-gray-50 border border-gray-300 rounded-lg">
                <div class="px-4 py-3 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-sm font-semibold text-black">Transaction History</h2>
                    <span id="transactionCount" class="text-xs text-gray-600">0 transactions</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Date & Time</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Client</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Amount</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Coins</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Method</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-600">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="px-4 py-3 border-t border-gray-300 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-xs text-gray-600">
                        Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalRecords">0</span> transactions
                    </div>
                    <div class="flex gap-2">
                        <button onclick="previousPage()" id="prevBtn" disabled
                            class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <span id="pageIndicator" class="px-3 py-1 text-sm text-gray-600">Page 1</span>
                        <button onclick="nextPage()" id="nextBtn" disabled
                            class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let currentPage = 1;
        const perPage = 20;
        let totalPages = 1;

        // Load transactions on page load
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            loadTransactions();
            loadStats();
        });

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/transactions/stats', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('todaySales').textContent = `₱${(stats.todaySales || 0).toFixed(2)}`;
                    document.getElementById('todayCoins').textContent = stats.todayCoins || 0;
                    document.getElementById('totalTransactions').textContent = stats.totalTransactions || 0;
                    document.getElementById('allTimeRevenue').textContent = `₱${(stats.allTimeRevenue || 0).toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTransactions() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const status = document.getElementById('statusFilter').value;
                const method = document.getElementById('methodFilter').value;

                const params = new URLSearchParams({
                    page: currentPage,
                    limit: perPage
                });
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (status) params.append('status', status);
                if (method) params.append('method', method);

                const response = await fetch(`/api/transactions?${params}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    transactions = data.transactions || [];
                    totalPages = data.totalPages || 1;
                    updateTable();
                    updatePagination(data.total || 0);
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-red-600">Error loading transactions</td>
                    </tr>
                `;
            }
        }

        function updateTable() {
            const tbody = document.getElementById('transactionsTable');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-600">No transactions found</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transactions.map(tx => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm text-gray-600">#${tx.id}</td>
                    <td class="px-4 py-2 text-sm text-black">${formatDateTime(tx.created_at)}</td>
                    <td class="px-4 py-2">
                        <div class="text-sm text-black">${tx.mac_address || tx.client_mac || 'Unknown'}</div>
                        <div class="text-xs text-gray-500">${tx.ip_address || tx.client_ip || ''}</div>
                    </td>
                    <td class="px-4 py-2 text-sm font-medium text-green-600">₱${(tx.amount || 0).toFixed(2)}</td>
                    <td class="px-4 py-2 text-sm text-black">${tx.coins_used || 0}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded ${getMethodBadgeClass(tx.payment_method)}">
                            ${tx.payment_method || 'COIN'}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded ${getStatusBadgeClass(tx.status)}">
                            ${tx.status || 'COMPLETED'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updatePagination(total) {
            const from = total === 0 ? 0 : ((currentPage - 1) * perPage) + 1;
            const to = Math.min(currentPage * perPage, total);
            
            document.getElementById('showingFrom').textContent = from;
            document.getElementById('showingTo').textContent = to;
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('transactionCount').textContent = `${total} transactions`;
            document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTransactions();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadTransactions();
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('en-PH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'COMPLETED': return 'bg-green-100 text-green-700';
                case 'PENDING': return 'bg-yellow-100 text-yellow-700';
                case 'FAILED': return 'bg-red-100 text-red-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        function getMethodBadgeClass(method) {
            switch (method) {
                case 'COIN': return 'bg-blue-100 text-blue-700';
                case 'FREE': return 'bg-purple-100 text-purple-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        function refreshTransactions() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('animate-spin');
            loadTransactions().finally(() => {
                loadStats();
                setTimeout(() => icon.classList.remove('animate-spin'), 500);
            });
        }

        function clearFilters() {
            setDefaultDates();
            document.getElementById('statusFilter').value = '';
            document.getElementById('methodFilter').value = '';
            currentPage = 1;
            loadTransactions();
        }

        document.getElementById('filter-form').addEventListener('submit', (e) => {
            e.preventDefault();
            currentPage = 1;
            loadTransactions();
        });

        async function exportTransactions() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const status = document.getElementById('statusFilter').value;
                const method = document.getElementById('methodFilter').value;

                const params = new URLSearchParams({ format: 'csv' });
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (status) params.append('status', status);
                if (method) params.append('method', method);

                const response = await fetch(`/api/transactions/export?${params}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `transactions_${startDate}_${endDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Export failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
