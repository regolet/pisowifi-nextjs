<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Slots & Queues - PISOWifi Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Compact table styling */
        table th,
        table td {
            padding: 0.5rem 1rem !important;
        }
        table tbody tr {
            height: auto !important;
        }

        .slot-available {
            @apply bg-green-100 border-green-300 text-green-800;
        }

        .slot-claimed {
            @apply bg-yellow-100 border-yellow-300 text-yellow-800;
        }

        .slot-active {
            @apply bg-blue-100 border-blue-300 text-blue-800;
        }

        .coin-queue-item {
            @apply bg-gray-50 border border-gray-200 rounded p-3 mb-2;
        }

        .status-badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
        }

        .refresh-animation {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen lg:flex">

    <!-- Include Admin Sidebar -->
    <%- include('../partials/admin-sidebar', {currentPage}) %>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto pt-14 lg:pt-0 lg:ml-0">
            <div class="p-6">
                <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                    <div>
                        <h1 class="text-xl font-bold text-black">Coin Slots & Queues</h1>
                        <p class="text-sm text-gray-600 mt-1">Monitor coin slot status and client queues</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="refreshData()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                            <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            Refresh
                        </button>
                        <button onclick="cleanupExpired()"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
                            Cleanup
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-xs text-gray-600">Available Slots</p>
                                <p id="availableSlots" class="text-lg font-semibold text-black">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5s-5 2.24-5 5v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"></path></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-xs text-gray-600">Claimed Slots</p>
                                <p id="claimedSlots" class="text-lg font-semibold text-black">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-xs text-gray-600">Queued Coins</p>
                                <p id="queuedCoins" class="text-lg font-semibold text-black">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-xs text-gray-600">Queue Value</p>
                                <p id="queueValue" class="text-lg font-semibold text-black">₱0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Coin Slots Table -->
                <div class="bg-gray-50 border border-gray-300 rounded-lg mb-6">
                    <div class="px-4 py-3 border-b border-gray-300">
                        <h2 class="text-sm font-semibold text-black">Physical Coin Slots</h2>
                        <p class="text-xs text-gray-600 mt-1">Real-time status of physical coin slot hardware</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Coin Slot
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Status
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Time Remaining
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        MAC Address
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        IP Address
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Queued Coins
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="coinSlotsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Coin slots will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Active Coin Queues -->
                <div class="bg-gray-50 border border-gray-300 rounded-lg">
                    <div class="px-4 py-3 border-b border-gray-300">
                        <h2 class="text-sm font-semibold text-black">Active Coin Queues</h2>
                        <p class="text-xs text-gray-600 mt-1">Clients with queued coins ready for redemption</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Client Info
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Coin Slot
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        MAC Address
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Queued Coins
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Total Value
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Queue Status
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Time Queued
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="coinQueuesTable" class="bg-white divide-y divide-gray-200">
                                <!-- Coin queues will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <script>
            let socket;
            let coinSlotsData = [];
            let coinQueuesData = [];

            // Initialize Socket.IO
            try {
                socket = io();

                socket.on('connect', function () {
                    console.log('Connected to server for real-time updates');
                });

                socket.on('coin-slot-claimed', function (data) {
                    console.log('Coin slot claimed:', data);
                    refreshData();
                });

                socket.on('coin-slot-released', function (data) {
                    console.log('Coin slot released:', data);
                    refreshData();
                });

                socket.on('coin-added', function (data) {
                    console.log('Coin added to queue:', data);
                    refreshData();
                });

                socket.on('coins-redeemed', function (data) {
                    console.log('Coins redeemed:', data);
                    refreshData();
                });
            } catch (error) {
                console.warn('Socket.IO connection failed:', error);
            }

            // Load data on page load
            document.addEventListener('DOMContentLoaded', function () {
                refreshData();

                // Auto-refresh every 30 seconds
                setInterval(refreshData, 30000);
            });

            async function refreshData() {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.classList.add('refresh-animation');

                try {
                    await Promise.all([
                        loadCoinSlots(),
                        loadCoinQueues()
                    ]);
                    updateStatistics();
                } catch (error) {
                    console.error('Failed to refresh data:', error);
                    showNotification('Failed to refresh data', 'error');
                } finally {
                    refreshIcon.classList.remove('refresh-animation');
                }
            }

            async function loadCoinSlots() {
                try {
                    const response = await fetch('/api/coin-slots/slots');
                    const data = await response.json();

                    if (data.success) {
                        coinSlotsData = data.slots;
                        renderCoinSlots();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Failed to load coin slots:', error);
                    throw error;
                }
            }

            async function loadCoinQueues() {
                try {
                    // Get detailed coin queues data
                    const response = await fetch('/api/coin-slots/queues');
                    const data = await response.json();

                    if (data.success) {
                        coinQueuesData = data.queues || [];
                        renderCoinQueues();
                    } else {
                        throw new Error(data.error || 'Failed to load coin queues');
                    }
                } catch (error) {
                    console.error('Failed to load coin queues:', error);
                    // Fallback to extracting from slot data
                    coinQueuesData = [];
                    coinSlotsData.forEach(slot => {
                        if (slot.queued_coins && slot.queued_coins.length > 0) {
                            slot.queued_coins.forEach(queue => {
                                coinQueuesData.push({
                                    ...queue,
                                    slot_number: slot.slot_number,
                                    claimed_by_ip: slot.claimed_by_ip,
                                    claimed_by_mac: slot.claimed_by_mac
                                });
                            });
                        }
                    });
                    renderCoinQueues();
                }
            }

            function renderCoinSlots() {
                const container = document.getElementById('coinSlotsTable');

                if (coinSlotsData.length === 0) {
                    container.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No coin slots configured</td></tr>';
                    return;
                }

                // Filter to show only slot 1 for Orange Pi standalone
                const orangePiSlots = coinSlotsData.filter(slot => slot.slot_number === 1);

                container.innerHTML = orangePiSlots.map(slot => {
                    const statusBadge = getStatusBadge(slot.status);
                    const queueCount = slot.queued_coins ? slot.queued_coins.length : 0;
                    const queueValue = slot.queued_coins ?
                        slot.queued_coins.reduce((sum, q) => sum + parseFloat(q.total_value), 0).toFixed(2) : '0.00';

                    // Calculate time remaining from expires_at
                    let timeRemaining = '';
                    if (slot.status === 'claimed' && slot.expires_at) {
                        const now = new Date();
                        const expiresAt = new Date(slot.expires_at);
                        const remainingMs = expiresAt - now;

                        if (remainingMs > 0) {
                            const minutes = Math.floor(remainingMs / 60000);
                            const seconds = Math.floor((remainingMs % 60000) / 1000);
                            timeRemaining = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        } else {
                            timeRemaining = 'Expired';
                        }
                    } else if (slot.status === 'available') {
                        timeRemaining = '-';
                    } else {
                        timeRemaining = 'N/A';
                    }

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <svg class="w-8 h-8 text-yellow-500 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 20c-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9-4.038 9-9 9zm3.5-9c0 1.933-1.567 3.5-3.5 3.5S8.5 13.933 8.5 12 10.067 8.5 12 8.5s3.5 1.567 3.5 3.5z"></path></svg>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">Slot ${slot.slot_number}</div>
                                    <div class="text-sm text-gray-500">Physical Hardware</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900" id="timer-${slot.slot_number}">
                                ${timeRemaining}
                            </div>
                            ${slot.status === 'claimed' ? `
                                <div class="text-xs text-gray-500">
                                    ${slot.expires_at ? new Date(slot.expires_at).toLocaleTimeString() : ''}
                                </div>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">
                                ${slot.claimed_by_mac || '-'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${slot.claimed_by_ip || '-'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${queueCount > 0 ? `${queueCount} coins` : '-'}
                            </div>
                            ${queueCount > 0 ? `
                                <div class="text-sm text-green-600 font-medium">₱${queueValue}</div>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${slot.status === 'claimed' ? `
                                <button onclick="releaseSlot(${slot.slot_number})" 
                                        class="text-red-600 hover:text-red-900 mr-3">
                                    Release
                                </button>
                            ` : ''}
                            ${queueCount > 0 ? `
                                <button onclick="redeemQueue('${slot.claimed_by_ip}', '${slot.claimed_by_mac || ''}')" 
                                        class="text-green-600 hover:text-green-900">
                                    Redeem
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                }).join('');

                // Start countdown timers
                startCountdownTimers();
            }

            function getStatusBadge(status) {
                switch (status) {
                    case 'available':
                        return '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Available</span>';
                    case 'claimed':
                        return '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Claimed</span>';
                    case 'active':
                        return '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Active</span>';
                    default:
                        return '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>';
                }
            }

            function startCountdownTimers() {
                // Clear existing timers
                if (window.countdownTimers) {
                    window.countdownTimers.forEach(timer => clearInterval(timer));
                }
                window.countdownTimers = [];

                // Start new timers for claimed slots
                coinSlotsData.forEach(slot => {
                    if (slot.status === 'claimed' && slot.expires_at) {
                        const timerId = setInterval(() => {
                            updateSlotTimer(slot.slot_number, slot.expires_at);
                        }, 1000);
                        window.countdownTimers.push(timerId);
                    }
                });
            }

            function updateSlotTimer(slotNumber, expiresAt) {
                const timerElement = document.getElementById(`timer-${slotNumber}`);
                if (!timerElement) return;

                const now = new Date();
                const expiresAtDate = new Date(expiresAt);
                const remainingMs = expiresAtDate - now;

                if (remainingMs > 0) {
                    const minutes = Math.floor(remainingMs / 60000);
                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    timerElement.className = 'text-sm font-medium text-yellow-600';
                } else {
                    timerElement.textContent = 'Expired';
                    timerElement.className = 'text-sm font-medium text-red-600';
                    // Refresh data when timer expires
                    setTimeout(refreshData, 1000);
                }
            }

            function renderCoinQueues() {
                const container = document.getElementById('coinQueuesTable');

                if (coinQueuesData.length === 0) {
                    container.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No active coin queues</td></tr>';
                    return;
                }

                // Group queues by client (IP + MAC combination)
                const groupedQueues = {};
                coinQueuesData.forEach(queue => {
                    const clientKey = `${queue.client_ip || queue.claimed_by_ip}-${queue.client_mac || queue.claimed_by_mac}`;
                    if (!groupedQueues[clientKey]) {
                        groupedQueues[clientKey] = {
                            client_ip: queue.client_ip || queue.claimed_by_ip,
                            client_mac: queue.client_mac || queue.claimed_by_mac,
                            slot_number: queue.slot_number || queue.slot_id,
                            queues: []
                        };
                    }
                    groupedQueues[clientKey].queues.push(queue);
                });

                container.innerHTML = Object.values(groupedQueues).map(clientData => {
                    const totalCoins = clientData.queues.reduce((sum, q) => sum + (q.coin_count || 1), 0);
                    const totalValue = clientData.queues.reduce((sum, q) => sum + parseFloat(q.total_value || q.coin_value || 0), 0);
                    const oldestQueue = clientData.queues.reduce((oldest, current) => {
                        return new Date(current.created_at) < new Date(oldest.created_at) ? current : oldest;
                    });
                    const queueStatus = clientData.queues.every(q => q.status === 'queued') ? 'Ready' : 'Processing';

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">Client ${clientData.client_ip || 'Unknown'}</div>
                                    <div class="text-sm text-gray-500">
                                        ${clientData.queues.length} queue${clientData.queues.length > 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 20c-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9-4.038 9-9 9zm3.5-9c0 1.933-1.567 3.5-3.5 3.5S8.5 13.933 8.5 12 10.067 8.5 12 8.5s3.5 1.567 3.5 3.5z"></path></svg>
                                <div class="text-sm font-medium text-gray-900">
                                    Slot ${clientData.slot_number || 1}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">
                                ${clientData.client_mac || '-'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${totalCoins} coin${totalCoins > 1 ? 's' : ''}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${clientData.queues.map(q => `₱${q.coin_value || 0} × ${q.coin_count || 1}`).join(', ')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-green-600">
                                ₱${totalValue.toFixed(2)}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${queueStatus === 'Ready' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                                ${queueStatus}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${new Date(oldestQueue.created_at).toLocaleTimeString()}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${Math.floor((new Date() - new Date(oldestQueue.created_at)) / 60000)}m ago
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="redeemQueue('${clientData.client_ip}', '${clientData.client_mac || ''}')" 
                                    class="text-green-600 hover:text-green-900 mr-3">
                                Redeem All
                            </button>
                            <button onclick="viewQueueDetails('${clientData.client_ip}', '${clientData.client_mac || ''}')" 
                                    class="text-blue-600 hover:text-blue-900">
                                Details
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function viewQueueDetails(clientIp, clientMac) {
                const clientQueues = coinQueuesData.filter(q =>
                    (q.client_ip === clientIp || q.claimed_by_ip === clientIp) &&
                    (q.client_mac === clientMac || q.claimed_by_mac === clientMac)
                );

                const detailsHtml = clientQueues.map(queue => `
                <div class="border rounded p-3 mb-2">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-medium">₱${queue.coin_value || 0} × ${queue.coin_count || 1}</span>
                            <span class="text-gray-500 text-sm ml-2">
                                ${new Date(queue.created_at).toLocaleString()}
                            </span>
                        </div>
                        <div class="text-green-600 font-medium">
                            ₱${parseFloat(queue.total_value || queue.coin_value || 0).toFixed(2)}
                        </div>
                    </div>
                </div>
            `).join('');

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Queue Details - ${clientIp}</h3>
                    <div class="max-h-60 overflow-y-auto">
                        ${detailsHtml}
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            }

            function updateStatistics() {
                const availableCount = coinSlotsData.filter(s => s.status === 'available').length;
                const claimedCount = coinSlotsData.filter(s => s.status === 'claimed').length;

                let totalQueuedCoins = 0;
                let totalQueueValue = 0;

                coinSlotsData.forEach(slot => {
                    if (slot.queued_coins) {
                        totalQueuedCoins += slot.queued_coins.reduce((sum, q) => sum + q.coin_count, 0);
                        totalQueueValue += slot.queued_coins.reduce((sum, q) => sum + parseFloat(q.total_value), 0);
                    }
                });

                document.getElementById('availableSlots').textContent = availableCount;
                document.getElementById('claimedSlots').textContent = claimedCount;
                document.getElementById('queuedCoins').textContent = totalQueuedCoins;
                document.getElementById('queueValue').textContent = '₱' + totalQueueValue.toFixed(2);
            }

            async function releaseSlot(slotNumber) {
                if (!confirm(`Release slot ${slotNumber}?`)) return;

                try {
                    const response = await fetch(`/api/coin-slots/slots/${slotNumber}/release`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification(`Slot ${slotNumber} released successfully`, 'success');
                        refreshData();
                    } else {
                        showNotification(`Failed to release slot: ${data.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Release slot error:', error);
                    showNotification('Failed to release slot', 'error');
                }
            }

            async function redeemQueue(clientIp, clientMac) {
                if (!confirm('Redeem all queued coins for this client?')) return;

                try {
                    const response = await fetch('/api/coin-slots/queues/redeem', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            clientIp: clientIp,
                            clientMac: clientMac || null
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification(`Redeemed ${data.totalCoins} coins worth ₱${data.totalValue.toFixed(2)}`, 'success');
                        refreshData();
                    } else {
                        showNotification(`Failed to redeem coins: ${data.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Redeem queue error:', error);
                    showNotification('Failed to redeem coins', 'error');
                }
            }

            async function cleanupExpired() {
                if (!confirm('Cleanup expired slots and queues?')) return;

                try {
                    const response = await fetch('/api/coin-slots/cleanup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification(`Cleanup completed: ${data.releasedSlots} slots, ${data.expiredQueues} queues`, 'success');
                        refreshData();
                    } else {
                        showNotification(`Cleanup failed: ${data.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Cleanup error:', error);
                    showNotification('Cleanup failed', 'error');
                }
            }

            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                        type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                            'bg-blue-100 text-blue-800 border border-blue-200'
                    }`;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        </script>

</body>

</html>